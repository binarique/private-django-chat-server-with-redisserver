
<!DOCTYPE html>
<html>
    <head>
        <meta charset="utf-8">
        <title>Messages</title>
    </head>
    <body>
        <textarea id="chat-log" cols="100" rows="20">
        {% for message in messages %}
        {{ message.username }} : {{ message.message }}
        {% endfor %}
        </textarea><br>

        <input id="chat-message-input" type="text" size="100"><br>
        <input id="chat-message-submit" type="button" value="Send"><br>
   {{ my_id|json_script:"my-id" }}
   {{ other_user_id|json_script:"other-user-id" }}
   {{ chat_no|json_script:"chat-no" }}
        <script>
    const my_id = JSON.parse(document.getElementById('my-id').textContent);
    const other_user_id = JSON.parse(document.getElementById('other-user-id').textContent);
    const chat_no = JSON.parse(document.getElementById('chat-no').textContent);
    var ws_url = 'ws://' + window.location.host + '/ws/chats/messages/' + my_id + '/' + other_user_id + '/' + chat_no + '/';
    const chatSocket = new WebSocket(ws_url);
    chatSocket.onmessage = function(e){
        const data = JSON.parse(e.data);
        console.log(data.message);
        document.querySelector("#chat-log").value += (data.message + '\n');

    };

    chatSocket.onclose = function(e){
      console.error('Chat socket closed unexpectedly');
    };
    document.querySelector('#chat-message-input').focus();
    document.querySelector('#chat-message-input').onkeyup = function(e){
        if(e.keyCode === 13){
            document.querySelector('#chat-message-submit').click();
        };
    }
    document.querySelector('#chat-message-submit').onclick = function(e){
       const messageInputDom = document.querySelector('#chat-message-input');
       const message = messageInputDom.value;
       if(message.length > 0){
       chatSocket.send(JSON.stringify({
           'message' : message,
       },),);
       messageInputDom.value = '';
    }
     
    }
        </script>
    </body>
</html>